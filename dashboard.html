<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter Pro CRM - 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .sidebar-item:hover { background-color: #eff6ff; color: #2563eb; transform: translateX(-5px); }
        .sidebar-item { transition: all 0.3s ease; }
        .active-nav { background-color: #dbeafe; color: #1d4ed8; border-right: 4px solid #1d4ed8; }
        /* Mobile handling */
        @media (max-width: 768px) { .desktop-sidebar { display: none; } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-white shadow-xl h-full flex flex-col z-20 hidden md:flex desktop-sidebar">
        <div class="p-6 border-b flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xl shadow-lg"><i class="fa-solid fa-crosshairs"></i></div>
            <div><h1 class="text-xl font-bold">Hunter Pro</h1><p class="text-xs text-gray-500">CRM v2.0</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="showSection('dashboard')" id="nav-dashboard" class="sidebar-item active-nav w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium"><i class="fa-solid fa-chart-pie w-6"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button onclick="showSection('hunt')" id="nav-hunt" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium"><i class="fa-solid fa-gem w-6"></i> Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø«</button>
            <button onclick="showSection('leads')" id="nav-leads" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium"><i class="fa-solid fa-users w-6"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            <button onclick="showSection('campaigns')" id="nav-campaigns" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium"><i class="fa-brands fa-whatsapp w-6"></i> Ø§Ù„Ø­Ù…Ù„Ø§Øª</button>
            <button onclick="showSection('chat')" id="nav-chat" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium"><i class="fa-solid fa-robot w-6"></i> Ø´Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†</button>
        </nav>
        <div class="p-4 border-t bg-gray-50"><button onclick="logout()" class="w-full text-red-600 py-2 text-sm"><i class="fa-solid fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button></div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto relative bg-slate-50 p-4 md:p-6">
        
        <div class="md:hidden flex justify-between items-center mb-6">
            <h1 class="font-bold text-lg text-blue-800">Hunter Pro</h1>
            <button onclick="logout()" class="text-red-500"><i class="fa-solid fa-power-off"></i></button>
        </div>

        <div id="section-dashboard" class="section-content animate-fade-in">
            <h2 class="text-2xl font-bold mb-6">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-gray-500 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="stat-leads">0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-gray-500 text-sm">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="stat-users">0</h3>
                </div>
            </div>
        </div>

        <div id="section-hunt" class="section-content hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-3xl p-8 text-white mb-8">
                <h2 class="text-3xl font-bold mb-2">Diamond Hunter ğŸ’</h2>
                <div class="grid grid-cols-1 gap-4 mt-6">
                    <input type="text" id="hunt-intent" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ù„ÙˆØ¨ Ø´Ù‚Ø© ÙÙŠ Ø§Ù„ØªØ¬Ù…Ø¹" class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 placeholder-white/70 text-white">
                    <select id="hunt-city" class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-black"><option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option><option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option></select>
                    <button onclick="startHunt()" class="w-full bg-yellow-400 text-blue-900 font-bold py-3 rounded-lg shadow-lg">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-2">Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                <textarea id="extract-text" class="w-full border rounded p-2 text-sm" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…..."></textarea>
                <button onclick="extractPhones()" class="mt-2 bg-gray-800 text-white px-4 py-2 rounded text-sm">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
                <div id="extract-res" class="mt-2 text-green-600 text-sm"></div>
            </div>
        </div>

        <div id="section-leads" class="section-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                <button onclick="loadLeads()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-x-auto">
                <table class="w-full text-right text-sm">
                    <thead class="bg-gray-50 text-gray-600"><tr><th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-4">Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th class="p-4">Ø§Ù„Ù…ØµØ¯Ø±</th><th class="p-4">ÙˆØ§ØªØ³Ø§Ø¨</th></tr></thead>
                    <tbody id="leads-body"></tbody>
                </table>
            </div>
        </div>

        <div id="section-campaigns" class="section-content hidden">
            <h2 class="text-2xl font-bold mb-6">Ø­Ù…Ù„Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø©</h3>
                <form onsubmit="createCampaign(event)" class="space-y-4">
                    <input name="name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©" required class="w-full border p-2 rounded">
                    <textarea name="message" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©" required class="w-full border p-2 rounded"></textarea>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded">Ø­ÙØ¸</button>
                </form>
            </div>
            <div id="campaigns-list" class="space-y-3"></div>
        </div>

        <div id="section-chat" class="section-content hidden h-[80vh] flex flex-col">
            <div class="bg-white p-4 rounded-t-xl border-b font-bold">ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†</div>
            <div id="chat-box" class="flex-1 bg-white p-4 overflow-y-auto space-y-2 border-x"></div>
            <div class="p-2 bg-white rounded-b-xl border flex gap-2">
                <input id="chat-input" class="flex-1 border p-2 rounded" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button onclick="sendChat()" class="bg-blue-600 text-white px-4 rounded"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </main>

    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input id="login-email" type="email" value="admin@example.com" class="w-full border p-3 rounded mb-3" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯">
            <input id="login-pass" type="password" value="admin123" class="w-full border p-3 rounded mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="login()" class="w-full bg-blue-600 text-white font-bold py-3 rounded">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <script>
        const API = ""; 
        let token = localStorage.getItem('token');
        let ws;

        if(token) document.getElementById('login-overlay').classList.add('hidden');
        if(token) initApp();

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            try {
                const res = await fetch(API + '/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                if(!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                const data = await res.json();
                token = data.access_token;
                localStorage.setItem('token', token);
                document.getElementById('login-overlay').classList.add('hidden');
                initApp();
            } catch(e) { alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£'); }
        }

        function logout() { localStorage.clear(); location.reload(); }

        function initApp() {
            loadStats();
            loadLeads();
            initWS();
        }

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(d => d.classList.add('hidden'));
            document.getElementById('section-'+id).classList.remove('hidden');
            if(id === 'campaigns') loadCampaigns();
        }

        async function loadStats() {
            const res = await fetch(API + '/api/admin-stats');
            const data = await res.json();
            document.getElementById('stat-leads').innerText = data.total_leads;
            document.getElementById('stat-users').innerText = data.total_users;
        }

        async function loadLeads() {
            const res = await fetch(API + '/api/leads');
            const data = await res.json();
            const html = data.leads.map(l => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold">${l.phone_number}</td>
                    <td class="p-3"><span class="bg-gray-100 px-2 rounded text-xs">${l.quality}</span></td>
                    <td class="p-3 text-xs text-gray-500">${l.source}</td>
                    <td class="p-3"><button onclick="sendSingleWS('${l.phone_number}')" class="text-green-600"><i class="fa-brands fa-whatsapp"></i></button></td>
                </tr>
            `).join('');
            document.getElementById('leads-body').innerHTML = html || '<tr><td colspan="4" class="text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        }

        async function startHunt() {
            const intent = document.getElementById('hunt-intent').value;
            const city = document.getElementById('hunt-city').value;
            if(!intent) return alert('Ø§ÙƒØªØ¨ Ø¨ØªØ¨Ø­Ø« Ø¹Ù† Ø§ÙŠÙ‡');
            Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«', text: 'Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©', icon: 'success'});
            await fetch(API + '/start_hunt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({intent_sentence: intent, city: city, user_id: 'admin'})
            });
        }

        async function extractPhones() {
            const text = document.getElementById('extract-text').value;
            const res = await fetch(API + '/api/extract-phones', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });
            const data = await res.json();
            document.getElementById('extract-res').innerText = `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬: ${data.phones.join(', ')}`;
        }

        async function createCampaign(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            fd.append('user_id', 'admin');
            await fetch(API + '/api/create-campaign', {method: 'POST', body: fd});
            loadCampaigns();
            e.target.reset();
        }

        async function loadCampaigns() {
            const res = await fetch(API + '/api/my-campaigns?user_id=admin');
            const data = await res.json();
            document.getElementById('campaigns-list').innerHTML = data.campaigns.map(c => `
                <div class="bg-gray-50 p-3 rounded border flex justify-between">
                    <div><b>${c.name}</b><br><small>${c.message}</small></div>
                    <button onclick="sendCamp('${c.id}')" class="text-blue-600">Ø§Ø±Ø³Ø§Ù„</button>
                </div>
            `).join('');
        }

        async function sendSingleWS(phone) {
            const msg = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:");
            if(msg) await fetch(API + '/api/send-whatsapp', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone_number: phone, message: msg, user_id: 'admin'})
            });
        }

        // Chat
        function initWS() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${location.host}/ws/admin-chat`);
            ws.onmessage = e => {
                const box = document.getElementById('chat-box');
                box.innerHTML += `<div class="bg-gray-100 p-2 rounded self-start max-w-[80%] text-sm mb-2">${e.data}</div>`;
                box.scrollTop = box.scrollHeight;
            };
        }
        function sendChat() {
            const inp = document.getElementById('chat-input');
            if(inp.value && ws) {
                ws.send(inp.value);
                const box = document.getElementById('chat-box');
                box.innerHTML += `<div class="bg-blue-100 p-2 rounded self-end max-w-[80%] text-sm mb-2 ml-auto">${inp.value}</div>`;
                inp.value = '';
                box.scrollTop = box.scrollHeight;
            }
        }
    </script>
</body>
</html>
